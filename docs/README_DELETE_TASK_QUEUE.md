# 删除任务队列系统 - 解决扫描与删除的并发冲突

## 问题背景

在bili-sync运行过程中，如果在扫描任务进行时删除视频源，会产生以下问题：

1. **数据竞争**：扫描任务和删除操作同时访问同一个视频源的数据
2. **数据库锁定**：两个操作同时访问数据库可能导致锁定冲突
3. **文件冲突**：扫描可能正在下载文件，删除操作尝试删除同一文件夹
4. **状态不一致**：删除操作可能删除正在被扫描任务使用的数据

## 解决方案

### 智能任务队列系统

实现了一个完整的删除任务队列管理系统，确保删除操作与扫描任务的安全协调：

#### 核心组件

1. **DeleteVideoSourceTask** - 删除任务结构体
2. **DeleteTaskQueue** - 删除任务队列管理器
3. **TaskController** - 增强的任务控制器，支持扫描状态检测
4. **智能API** - 支持状态检测的删除API

#### 工作流程

```
用户请求删除视频源
        ↓
检测是否正在扫描？
    ↓           ↓
   是           否
    ↓           ↓
加入任务队列    直接执行删除
    ↓           ↓
等待扫描完成    返回删除结果
    ↓
扫描完成后自动处理队列
    ↓
返回处理结果
```

## 功能特性

### 扫描状态监控
- 实时检测扫描任务状态
- 精确的扫描开始/结束标记
- 非阻塞的状态查询

### 智能任务队列
- 先进先出队列管理
- 任务去重和状态追踪
- 详细的日志记录

### Web界面管理
- 直观的任务队列状态展示
- 实时扫描状态指示器
- 队列计数和状态监控
- 用户友好的可视化界面

### 安全的并发控制
- 原子操作保证线程安全
- 避免数据竞争和死锁
- 优雅的错误处理

### 自动任务处理
- 扫描完成后自动处理队列
- 批量处理提高效率
- 失败重试机制

## API使用方法

### 删除视频源 API

**请求示例：**
```bash
DELETE /api/video-sources/collection/1?delete_local_files=true
```

**场景1：非扫描期间 - 直接删除**
```json
{
  "status_code": 200,
  "data": {
    "success": true,
    "source_id": 1,
    "source_type": "collection",
    "message": "合集 [名称] 已成功删除"
  }
}
```

**场景2：扫描期间 - 队列处理**
```json
{
  "status_code": 200,
  "data": {
    "success": true,
    "source_id": 1,
    "source_type": "collection",
    "message": "正在扫描中，删除任务已加入队列，将在扫描完成后自动处理"
  }
}
```

## 技术细节

### 核心数据结构

#### DeleteVideoSourceTask
```rust
#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct DeleteVideoSourceTask {
    pub source_type: String,     // 视频源类型
    pub source_id: i32,          // 视频源ID
    pub delete_local_files: bool, // 是否删除本地文件
    pub task_id: String,         // 唯一任务ID
}
```

#### TaskController 增强版
```rust
pub struct TaskController {
    pub is_paused: AtomicBool,   // 是否暂停扫描
    pub is_scanning: AtomicBool, // 是否正在扫描
}
```

### 线程安全机制

- **AtomicBool**: 保证扫描状态的原子性读写
- **Mutex VecDeque**: 保护任务队列的并发访问
- **Arc**: 在多个任务间安全共享状态

### 性能优化

- **非阻塞检测**: 状态查询不影响主要业务逻辑
- **批量处理**: 队列任务批量执行，减少开销
- **间隔控制**: 任务间适当延迟，避免过度负载

## 使用场景

### 定期维护
用户在系统运行期间删除不需要的视频源，系统会自动协调操作时机。

### 批量管理
同时删除多个视频源时，系统会智能排队处理，避免冲突。

### 系统集成
其他模块可以通过队列系统安全地执行删除操作。

## 日志示例

### 扫描期间的删除请求
```
INFO 检测到正在扫描，删除任务已加入队列等待处理: collection ID=1
INFO 删除任务已加入队列: collection ID=1, 队列长度: 1
```

### 扫描完成后的自动处理
```
INFO 扫描任务结束
INFO 开始处理暂存的删除任务，当前队列长度: 1
INFO 正在处理删除任务: collection ID=1 
INFO 删除任务执行成功: 合集 [名称] 已成功删除
INFO 删除任务队列处理完成，共处理 1 个任务
```

## 配置和维护

### Web界面监控

系统提供了直观的Web管理界面来监控任务队列状态：

![任务队列管理界面](./assets/任务队列.webp)

**界面功能说明：**
- **扫描状态指示**：实时显示当前是否正在扫描，绿色勾号表示扫描中
- **删除队列计数**：显示当前等待处理的删除任务数量
- **添加队列计数**：显示等待添加的视频源任务数量  
- **配置队列计数**：显示等待处理的配置更新任务数量

### 队列监控
系统提供完整的队列状态监控：
- 当前队列长度
- 处理状态
- 任务执行结果

### 错误处理
- 任务执行失败会记录详细错误日志
- 不会影响其他任务的执行
- 提供完整的错误追踪信息

## 总结

这个删除任务队列系统完美解决了扫描与删除操作的并发冲突问题，通过：

1. **智能检测** - 实时监控扫描状态
2. **队列管理** - 安全暂存删除任务  
3. **自动处理** - 扫描完成后自动执行
4. **安全保障** - 避免数据竞争和冲突

用户无需关心技术细节，系统会自动处理所有的协调工作，确保操作的安全性和可靠性。 