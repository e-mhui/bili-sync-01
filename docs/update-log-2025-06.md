# 📝 更新日志 - 2025年6月

## 🎉 v2.6.2 版本发布

### 日期：2025年6月1日

### 概述
本次更新主要修复了番剧弹幕下载失败的问题，并大幅优化了番剧详情获取的性能，显著提升了下载体验。

### 🐛 问题修复

#### 1. 修复番剧弹幕下载失败问题

**问题描述**：
- 番剧下载时弹幕文件获取失败，返回 304 错误
- 下载接口缺少必要的 `pid` 参数导致请求无效

**解决方案**：
- ✅ 添加了缺失的 `pid` 参数（分P ID）
- ✅ 支持番剧专用的 `aid` 参数（番剧使用特殊的 aid 而非 bvid）
- ✅ 改进了错误处理机制，避免无效的弹幕下载尝试

**技术细节**：
```rust
// 修复前：缺少 pid 参数
let url = format!("https://api.bilibili.com/x/v1/dm/list.so?oid={}", cid);

// 修复后：添加 pid 参数
let params = vec![
    ("oid", cid.to_string()),
    ("pid", aid.to_string()),  // 新增的关键参数
];
```

### ⚡ 性能优化

#### 1. 番剧详情获取性能大幅提升

**优化前**：
- 串行获取每集详情，速度极慢
- 30 集番剧需要 50-60 秒
- 1221 集柯南需要近 50 分钟

**优化后**：
- 改为并发获取，性能提升 **25-30 倍**
- 30 集番剧仅需 2 秒
- 1221 集柯南仅需 100 秒

**性能对比**：
| 内容 | 优化前 | 优化后 | 提升倍数 |
|------|--------|--------|----------|
| 30集番剧 | 50-60秒 | 2秒 | 25-30x |
| 100集番剧 | 约3分钟 | 6-8秒 | 22-30x |
| 1221集柯南 | 近50分钟 | 100秒 | 30x |

**实现方式**：
```rust
// 优化前：串行处理
for ep in episodes {
    let detail = fetch_episode_detail(ep).await?;
    results.push(detail);
}

// 优化后：并发处理
let tasks: Vec<_> = episodes.into_iter()
    .map(|ep| fetch_episode_detail(ep))
    .collect();
let results = futures::future::try_join_all(tasks).await?;
```

### 🔧 其他改进

1. **日志优化**
   - 减少了不必要的警告日志
   - 让日志输出更加清晰

2. **代码质量**
   - 消除了编译警告
   - 优化了代码结构

3. **错误处理**
   - 改进了网络请求的错误处理
   - 提供更友好的错误提示

### 📊 实际测试结果

在实际测试中，性能提升效果显著：

- **《工作细胞》（14集）**：2秒完成
- **《某科学的超电磁炮》系列（74集）**：8秒完成
- **《名侦探柯南》（1221集）**：100秒完成

### 🚀 升级建议

强烈建议所有用户升级到 v2.6.2 版本，特别是：
- 需要下载番剧的用户
- 下载大量剧集的用户
- 之前遇到弹幕下载失败的用户

### 📝 技术总结

本次更新通过添加关键参数和改进并发策略，不仅解决了功能性问题，还带来了显著的性能提升。这展示了正确的API使用和合理的并发设计对程序性能的重要影响。

---

**相关提交**：
- `fix: 修复番剧弹幕下载问题，添加缺失的pid参数`
- `fix: 修复番剧弹幕下载，支持番剧的aid参数`
- `feat: 优化番剧弹幕下载和详情获取性能`
- `chore: 发布 bili-sync v2.6.2` 