# 更新记录

## v2.7.6.3 (2025-07-28)
### 修复番剧源数据持久化问题
- **番剧源数据丢失修复**: 彻底解决番剧源重启后消失的问题
  - 移除video_source表的特殊存在性检查逻辑，导致INSERT操作被错误转为UPDATE
  - 统一所有表使用标准主键检查逻辑，确保数据同步一致性
  - 修复内存数据库同步机制，番剧源现在与其他源类型行为完全一致
  - 从日志可见：添加时操作=INSERT，退出时操作=INSERT（之前错误为UPDATE）

### 日志系统优化
- **减少冗余日志输出**: 优化内存数据库同步日志级别
  - 将详细的表同步过程日志从info降级到debug级别
  - 保留关键操作结果（如"番剧添加成功"、"数据同步完成"）为info级别
  - 只有实际发生数据变更的表才输出info级别同步结果
  - 无数据变更的表使用debug级别，避免日志冗余

### 技术改进
- 移除了导致数据不一致的特殊处理逻辑
- 统一数据库同步策略，提升系统稳定性
- 优化日志输出，在保持调试能力的同时减少噪音

## v2.7.6.2 (2025-07-28)
### 内存数据库优化改进
- **数据安全保障**: 解决内存数据库导致的重复下载问题
  - 每轮扫描完成后自动同步数据到主数据库
  - 实现定期自动同步机制，防止断电数据丢失
  - 每处理10个视频或每5分钟自动同步一次
  - 程序退出时确保所有数据写回主数据库

- **视频源处理优化**: 修复视频源处理顺序问题
  - 删除无用的批量视频源转换代码，避免重复转换
  - 确保新添加的视频源真正优先处理
  - 修复日志输出顺序，使其与实际处理顺序一致

- **推送通知修复**: 修复多个推送相关问题
  - 修复Server酱推送日期显示为1970-01-01的问题
  - 修复Submission类型视频缺少pubtime字段设置
  - 修复番剧视频推送不显示时间戳的问题
  - 确保所有视频类型的推送都包含正确的时间信息

- **内存数据库表查询修复**: 修复"no such table: video_source"错误
  - 统一所有数据库操作使用优化连接
  - 确保内存模式下所有查询都在内存数据库执行
  - 修复函数签名以支持Arc<DatabaseConnection>传递

### 技术改进
- 优化内存数据库同步策略，平衡性能与数据安全
- 改进全局内存优化器，支持保持内存模式的同步操作
- 增强程序健壮性，防止意外中断导致的数据丢失
- 统一数据库连接使用，避免混用不同连接导致的错误

## v2.7.6.1 (2025-07-27)
### 时间格式统一优化
- **统一时间格式**: 全系统使用标准时间格式 `YYYY-MM-DD HH:MM:SS`，移除毫秒和时区信息
  - 创建通用时间格式模块 `time_format.rs`
  - 修复数据库中所有 `created_at` 字段的时间格式解析错误
  - 统一 submission、favorite、collection、bangumi、watch_later 等表的时间处理
  - 新增数据库迁移脚本，自动转换现有数据格式

### 日志系统性能优化
- **异步日志写入**: 实现基于内存缓冲的异步日志系统
  - 日志先写入内存缓冲区，减少磁盘I/O阻塞
  - 扫描完成后统一刷写到磁盘，提升NAS环境性能
  - 解决容器环境下同步写入导致的严重性能问题
  - NAS扫描性能从12分钟优化到与PC相当的秒级处理

### 时区配置简化
- **移除时区复杂配置**: 简化系统配置，移除不必要的时区设置
  - 移除后端 `timezone` 和 `use_local_timezone` 配置字段
  - 移除前端时区选择器组件和相关UI
  - 清理时区转换相关代码，减少系统复杂度
  - 统一使用本地时间，避免时区转换带来的问题

### 界面体验优化
- **输入框对比度修复**: 修复黑暗模式下输入框文本对比度不足问题
  - 统一输入组件的文本颜色类 `text-foreground dark:text-foreground`
  - 修复删除确认对话框、搜索栏等关键输入框的可见性
  - 提升黑暗模式下的用户体验

### 修复问题
- **数据库约束修复**: 修复稍后再看视频源添加失败问题
  - 解决 `watch_later.scan_deleted_videos` NOT NULL 约束失败
  - 修复时区迁移导致的数据库字段问题
  - 确保API创建记录时正确设置所有必需字段

### 技术改进
- 优化文件日志系统的内存使用和性能
- 改进容器环境下的I/O操作策略
- 简化配置结构，减少维护成本
- 统一时间处理逻辑，避免格式不一致问题

## v2.7.6 (2025-07-26)
### 新增功能
- **Server酱推送优化**: 完全重构推送通知系统，提升新视频识别准确性
  - 增强NewVideoInfo结构体，添加发布时间和集数信息字段
  - 改进新视频收集逻辑，通过数据库查询准确识别真正新增的视频
  - 优化推送内容格式，番剧按集数排序，其他视频按时间排序
  - 修复番剧推送时集数识别错误问题（如显示第5集为新但实际更新到第12集）

- **日志系统优化**：
  - 新增文件日志系统，所有日志自动保存到文件
  - 日志文件包含启动时间戳，格式：`logs-{级别}-{年月日}-{时分秒}.csv`
  - 日志文件保存在配置目录的 `logs` 子目录下
  - 支持按级别分文件存储（全部、debug、info、warn、error）
  - 自动清理超过30天的旧日志文件
  - 新增API端点 `/api/logs/files` 和 `/api/logs/download/{filename}` 用于日志文件管理
  - 前端保持显示最新1万行日志，完整日志可通过文件下载

### 修复问题
- **充电视频误判修复**: 修复正常视频被误判为充电专享视频的问题
  - 修正了视频流为空时错误使用87008错误码的逻辑
  - 现在只有B站API明确返回87007/87008时才判定为充电专享视频
  - 其他原因（地区限制、版权问题等）导致的视频流为空不再触发自动删除
  - 新增VideoStreamEmpty错误类型，正确区分不同的视频流错误

- **试看视频处理优化**: 
  - 识别并正确处理durl格式的试看视频（通常只有5-6秒）
  - 将试看视频标记为充电视频，避免下载无用的片段
  - 只接受dash格式的完整视频流进行下载

### 技术改进
- 统一时间处理逻辑，全面使用北京时间字符串格式
- 推送通知支持显示视频发布日期和番剧集数信息
- 新视频判定逻辑优化，避免重复推送已存在视频
- 增强API响应日志，详细记录视频流获取失败的原因

## 2025-07-24
### 新增功能
- **扫描源顺序优化**: 新添加的源优先扫描，然后扫描旧源，提升扫描效率
- **风控断点续传**: 触发风控时保存扫描进度，下次扫描从断点继续
- **显示错误视频**: 视频管理页新增筛选错误视频功能，方便排查问题
- **强制重置功能**: 重置对话框区分"重置失败任务"和"强制重置所有"

### 界面优化
- **黑暗模式适配**: API Token登录页面完整支持黑暗模式
- **批量重置优化**: 明确区分重置失败任务和强制重置，避免误操作

### 系统优化
- **风控处理优化**: HTTP 412错误风控检测更加准确，支持源间延迟配置
- **扫描进度保存**: 修复进度保存时机，确保只有完全处理完的源才被记录
- **配置更新优化**: 新增延迟字段到API配置，提升系统稳定性

### 技术改进
- 扫描源ID跟踪功能，支持新旧源分组处理
- 扫描进度实时保存，避免程序异常退出时进度丢失
- 风控时延迟保存策略，确保断点续传的准确性

## 2025-07-23
- 修复番剧缓存未生效问题
- 番剧扫描速度提升 60 倍

## 2025-07-22  
- 添加番剧缓存机制（24小时）
- 新增缓存字段到数据库

## 2025-07-21
- 修复 QR 登录重复生成问题
- 优化登录流程

## 2025-07-20
- 优化视频元数据获取
- 修复封面图片路径问题

## 2025-07-19
- 改进错误处理机制
- 优化任务队列性能

## 更早版本
详见 [GitHub Releases](https://github.com/qq1582185982/bili-sync-01/releases)